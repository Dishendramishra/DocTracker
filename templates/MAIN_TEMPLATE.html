<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document Management Portal</title>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='images/favicon.ico') }}">
    <link href="{{ url_for('static', filename='css/flowbite.min.css') }}" rel="stylesheet" />
    <link href="{{ url_for('static', filename='css/select2.min.css') }}" rel="stylesheet" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/sweetalert2.min.css') }}">
    <script src="{{ url_for('static', filename='js/tailwind-cdn.js') }}"></script>
    <script src="{{ url_for('static', filename='js/jquery-3.6.0.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/flowbite.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/select2.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/sweetalert2.min.js') }}"></script>
</head>
<body class="bg-gray-50">
    <nav class="bg-blue-600 text-white shadow-lg">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold">üìÅ Document Management Portal</h1>
                <p class="text-blue-100 text-sm">Welcome, {{ current_user.username }} ({{ current_user.role }})</p>
            </div>
                <div class="flex gap-4">
                {% if current_user.role == 'admin' %}
                <a href="{{ url_for('users') }}" class="px-4 py-2 bg-blue-700 rounded-lg hover:bg-blue-800 transition">
                    üë• Users
                </a>
                {% endif %}
                <a href="{{ url_for('change_password') }}" class="px-4 py-2 bg-blue-700 rounded-lg hover:bg-blue-800 transition">
                    üîë Change Password
                </a>
                <a href="{{ url_for('export_csv') }}" class="px-4 py-2 bg-blue-700 rounded-lg hover:bg-blue-800 transition">
                    üìä Export
                </a>
                <a href="{{ url_for('logout') }}" class="px-4 py-2 bg-red-600 rounded-lg hover:bg-red-700 transition">
                    Logout
                </a>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-8">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                <div class="mb-4 p-4 rounded-lg {% if category == 'error' %}bg-red-100 text-red-700{% else %}bg-green-100 text-green-700{% endif %}">
                    {{ message }}
                </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <div class="grid md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white p-6 rounded-lg shadow-md">
                <div class="text-3xl font-bold text-blue-600">{{ stats.total }}</div>
                <div class="text-gray-600">Total Documents</div>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md">
                <div class="text-3xl font-bold text-green-600">{{ stats.this_month }}</div>
                <div class="text-gray-600">This Month</div>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md">
                <div class="text-3xl font-bold text-purple-600">{{ stats.departments }}</div>
                <div class="text-gray-600">Departments</div>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md">
                <div class="text-3xl font-bold text-orange-600">{{ stats.my_docs }}</div>
                <div class="text-gray-600">My Documents</div>
            </div>
        </div>

        <!-- Upload Form -->
        <div class="bg-green-100 rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4 text-gray-800">üì§ Upload New Document</h2>
            <form id="uploadForm" method="POST" enctype="multipart/form-data" action="{{ url_for('upload') }}">
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Document File (PDF)</label>
                        <input type="file" name="file" accept=".pdf" required
                               class="w-full px-3 border border-gray-300 bg-white rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Document Type</label>
                        <select name="doc_type" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option class='bg-gray-100' value="">Select Type</option>
                            <option class='bg-gray-100' value="Purchase Order">Purchase Order</option>
                            <option class='bg-gray-100' value="Office Notice">Office Notice</option>
                            <option class='bg-gray-100' value="Office Note">Office Note</option>
                            <option class='bg-gray-100' value="Payment Note">Payment Note</option>
                            <option class='bg-gray-100' value="Invoice">Invoice</option>
                            <option class='bg-gray-100' value="TAF">TAF</option>
                            <option class='bg-gray-100' value="Memorandum">Memorandum</option>
                            <option class='bg-gray-100' value="Minutes of Committee">Minutes of Committee</option>
                            <option class='bg-gray-100' value="Board Minutes">Board Minutes</option>
                            <option class='bg-gray-100' value="Board Approval">Board Approval</option>
                            <option class='bg-gray-100' value="Email Communication">Email Communication</option>
                            <option class='bg-gray-100' value="Letter">Letter</option>
                            <option class='bg-gray-100' value="Policy">Policy</option>
                            <option class='bg-gray-100' value="SOP">SOP</option>
                            <option class='bg-gray-100' value="Report">Report</option>
                            <option class='bg-gray-100' value="SLA">SLA</option>
                            <option class='bg-gray-100' value="Circular">Circular</option>
                            <option class='bg-gray-100' value="Miscellaneous">Miscellaneous</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Department</label>
                        <select name="department" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="">Select Department</option>
                            <option value="HRDD - Human Resource Development Division" {% if current_user.department == 'HRDD - Human Resource Development Division' %}selected{% endif %}>HRDD - Human Resource Development Division</option>
                            <option value="CAD - Credit Administration Division" {% if current_user.department == 'CAD - Credit Administration Division' %}selected{% endif %}>CAD - Credit Administration Division</option>
                            <option value="CMS - Chairman Secretariat" {% if current_user.department == 'CMS - Chairman Secretariat' %}selected{% endif %}>CMS - Chairman Secretariat</option>
                            <option value="CBDT - Capacity Building and Training Cell" {% if current_user.department == 'CBDT - Capacity Building and Training Cell' %}selected{% endif %}>CBDT - Capacity Building and Training Cell</option>
                            <option value="CRMD - Credit Risk Management Division" {% if current_user.department == 'CRMD - Credit Risk Management Division' %}selected{% endif %}>CRMD - Credit Risk Management Division</option>
                            <option value="Compliance Division" {% if current_user.department == 'Compliance Division' %}selected{% endif %}>Compliance Division</option>
                            <option value="Customer Service Division" {% if current_user.department == 'Customer Service Division' %}selected{% endif %}>Customer Service Division</option>
                            <option value="Digital Banking Division" {% if current_user.department == 'Digital Banking Division' %}selected{% endif %}>Digital Banking Division</option>
                            <option value="ITD - Information Technology Division" {% if current_user.department == 'ITD - Information Technology Division' %}selected{% endif %}>ITD - Information Technology Division</option>
                            <option value="FD - Finance Division" {% if current_user.department == 'FD - Finance Division' %}selected{% endif %}>FD - Finance Division</option>
                            <option value="FID - Financial Inclusion Division" {% if current_user.department == 'FID - Financial Inclusion Division' %}selected{% endif %}>FID - Financial Inclusion Division</option>
                            <option value="IRMD - Integrated Risk Management Division" {% if current_user.department == 'IRMD - Integrated Risk Management Division' %}selected{% endif %}>IRMD - Integrated Risk Management Division</option>
                            <option value="Management Advisory and Services Division" {% if current_user.department == 'Management Advisory and Services Division' %}selected{% endif %}>Management Advisory and Services Division</option>
                            <option value="GAD - General Administration Division" {% if current_user.department == 'GAD - General Administration Division' %}selected{% endif %}>GAD - General Administration Division</option>
                            <option value="IAD - Inspection And Audit Division" {% if current_user.department == 'IAD - Inspection And Audit Division' %}selected{% endif %}>IAD - Inspection And Audit Division</option>
                            <option value="SAMD - Special Assets Management Division" {% if current_user.department == 'SAMD - Special Assets Management Division' %}selected{% endif %}>SAMD - Special Assets Management Division</option>
                            <option value="TMD - Transaction Monitoring Division" {% if current_user.department == 'TMD - Transaction Monitoring Division' %}selected{% endif %}>TMD - Transaction Monitoring Division</option>
                            <option value="M&ID - Marketing & Insurance Division" {% if current_user.department == 'M&ID - Marketing & Insurance Division' %}selected{% endif %}>M&ID - Marketing & Insurance Division</option>
                            <option value="Rajbhasha Division" {% if current_user.department == 'Rajbhasha Division' %}selected{% endif %}>Rajbhasha Division</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Document Date</label>
                        <input type="date" name="doc_date" value="{{ today_date.strftime('%Y-%m-%d') }}" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div class="md:col-span-1">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Description (Optional)</label>
                        <textarea name="description" rows="2"
                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                  placeholder="Brief description of the document"></textarea>
                    </div>
                    
                    <div class="md:col-span-1">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Link to Related Documents (Optional)</label>
                        <select id="linked_docs" name="linked_docs" multiple data-placeholder="Search and select related documents..."
                                class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                            {% for doc in all_documents %}
                            <option value="{{ doc.id }}">{{ doc.original_filename }} ({{ doc.doc_type }})</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <button type="submit"
                        class="mt-4 bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition font-medium">
                    Upload Document
                </button>
            </form>
        </div>

        <!-- Search and Filter -->
        <div class="bg-blue-100 rounded-lg shadow-md p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4 text-gray-800">üîç Search & Filter</h2>
            <form method="GET" action="{{ url_for('index') }}" class="flex flex-wrap items-center gap-4">
                <input type="text" name="search" value="{{ request.args.get('search', '') }}"
                       placeholder="Search filename or description"
                       class="flex-1 min-w-[220px] px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                
                <select name="doc_type"
                        class="w-48 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    <option value="">All Types</option>
                    <option value="Purchase Order" {% if request.args.get('doc_type') == 'Purchase Order' %}selected{% endif %}>Purchase Order</option>
                    <option value="Office Notice" {% if request.args.get('doc_type') == 'Office Notice' %}selected{% endif %}>Office Notice</option>
                    <option value="Office Note" {% if request.args.get('doc_type') == 'Office Note' %}selected{% endif %}>Office Note</option>
                    <option value="Payment Note" {% if request.args.get('doc_type') == 'Payment Note' %}selected{% endif %}>Payment Note</option>
                    <option value="Invoice" {% if request.args.get('doc_type') == 'Invoice' %}selected{% endif %}>Invoice</option>
                    <option value="TAF" {% if request.args.get('doc_type') == 'TAF' %}selected{% endif %}>TAF</option>
                    <option value="Memorandum" {% if request.args.get('doc_type') == 'Memorandum' %}selected{% endif %}>Memorandum</option>
                    <option value="Minutes of Committee" {% if request.args.get('doc_type') == 'Minutes of Committee' %}selected{% endif %}>Minutes of Committee</option>
                    <option value="Board Minutes" {% if request.args.get('doc_type') == 'Board Minutes' %}selected{% endif %}>Board Minutes</option>
                    <option value="Board Approval" {% if request.args.get('doc_type') == 'Board Approval' %}selected{% endif %}>Board Approval</option>
                    <option value="Email Communication" {% if request.args.get('doc_type') == 'Email Communication' %}selected{% endif %}>Email Communication</option>
                    <option value="Letter" {% if request.args.get('doc_type') == 'Letter' %}selected{% endif %}>Letter</option>
                    <option value="Policy" {% if request.args.get('doc_type') == 'Policy' %}selected{% endif %}>Policy</option>
                    <option value="SOP" {% if request.args.get('doc_type') == 'SOP' %}selected{% endif %}>SOP</option>
                    <option value="Report" {% if request.args.get('doc_type') == 'Report' %}selected{% endif %}>Report</option>
                    <option value="SLA" {% if request.args.get('doc_type') == 'SLA' %}selected{% endif %}>SLA</option>
                    <option value="Circular" {% if request.args.get('doc_type') == 'Circular' %}selected{% endif %}>Circular</option>
                    <option value="Miscellaneous" {% if request.args.get('doc_type') == 'Miscellaneous' %}selected{% endif %}>Miscellaneous</option>
                </select>
                
                  <input type="text" name="department" value="{{ request.args.get('department', '') }}"
                      placeholder="Filter by department"
                      class="w-48 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                
                <button type="submit"
                        class="bg-yellow-500 text-white px-4 py-2 rounded-lg hover:bg-yellow-600 transition">
                    Apply Filters
                </button>
                
                <button type="button" onclick="clearFilters()"
                        class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition ml-2">
                    Clear Filters
                </button>
            </form>
        </div>

        <!-- Documents List -->
        <div class="bg-indigo-100 rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold mb-4 text-gray-800">üìã Documents ({{ documents|length }})</h2>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50 border-b-2 border-gray-200">
                        <tr>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">ID</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Filename</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Type</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Department</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Doc Date</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Uploaded By</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Links</th>
                            <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        {% for doc in documents %}
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-3 text-sm text-gray-700">{{ doc.id }}</td>
                            <td class="px-4 py-3 text-sm">
                                <div class="font-medium text-gray-900">{{ doc.original_filename }}</div>
                                {% if doc.description %}
                                <div class="text-gray-500 text-xs">{{ doc.description }}</div>
                                {% endif %}
                            </td>
                            <td class="px-4 py-3 text-sm">
                                <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-medium">
                                    {{ doc.doc_type }}
                                </span>
                            </td>
                            <td class="px-4 py-3 text-sm text-gray-700">{{ doc.department }}</td>
                            <td class="px-4 py-3 text-sm text-gray-700">{{ doc.doc_date.strftime('%Y-%m-%d') }}</td>
                            <td class="px-4 py-3 text-sm text-gray-600">{{ doc.uploader.username if doc.uploader else 'N/A' }}</td>
                            <td class="px-4 py-3 text-sm">
                                {% set link_count = doc.linked_to|length + doc.linked_from|length %}
                                {% if link_count > 0 %}
                                <a href="{{ url_for('view_document', doc_id=doc.id) }}" 
                                   class="text-purple-600 hover:text-purple-800 font-medium">
                                    üîó {{ link_count }} link(s)
                                </a>
                                {% else %}
                                <span class="text-gray-400">No links</span>
                                {% endif %}
                            </td>
                            <td class="px-4 py-3 text-sm">
                                <a href="{{ url_for('view_document', doc_id=doc.id) }}"
                                   class="text-blue-600 hover:text-blue-800 font-medium mr-2">View</a>
                                <a href="{{ url_for('download', doc_id=doc.id) }}"
                                   class="text-green-600 hover:text-green-800 font-medium mr-2">Download</a>
                                {% if current_user.role == 'admin' or doc.uploaded_by == current_user.id %}
                                <a href="{{ url_for('delete', doc_id=doc.id) }}"
                                   onclick="return confirm('Are you sure you want to delete this document?')"
                                   class="text-red-600 hover:text-red-800 font-medium">Delete</a>
                                {% endif %}
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="8" class="px-4 py-8 text-center text-gray-500">
                                No documents found. Upload your first document above!
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            $('#linked_docs').select2({
                placeholder: 'Search and select related documents...',
                allowClear: true,
                width: '100%'
            });

            document.getElementById('uploadForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const formData = new FormData(this);
                fetch(this.action, {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Upload Successful!',
                            text: data.message,
                            confirmButtonColor: '#3085d6',
                            showCloseButton: true
                        }).then(() => {
                            window.location.reload();
                        });
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Upload Failed',
                            text: data.message,
                            confirmButtonColor: '#d33',
                            showCloseButton: true
                        });
                    }
                })
                .catch(error => {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'An unexpected error occurred.',
                        confirmButtonColor: '#d33',
                        showCloseButton: true
                    });
                });
            });
        });

        function clearFilters() {
            window.location.href = '{{ url_for("index") }}';
        }
    </script>
</body>
</html>